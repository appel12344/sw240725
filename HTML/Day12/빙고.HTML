<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>리무쿠라의 3X3 빙고게임</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        #content {
            display: none; /* 초기에는 숨김 */
            padding: 20px;
            background-color: #5fe8e5d6;
            border: 1px solid #000000e7;
            margin-top: 10px;
        }
    </style>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        h1 {
            margin-bottom: 505px;
        }
        .btn {
            cursor: pointer;
            border: none;
            border-radius: 5px;
            color: rgb(0, 0, 0);
            font-weight: bold;
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .line {
            position: absolute;
            background-color: red;
            z-index: 0;
        }
    </style>
    <script>
        // 3x3 그리드 상태를 저장하는 배열
        let board = [
            [null, null, null],
            [null, null, null],
            [null, null, null]
        ];

        let currentPlayer = 'O';

        function MakeBox(cssValue) {
            this.div = document.createElement('div');
            this.div.style.position = "absolute";
            this.div.style.border = "1px solid black";
            this.div.style.left = cssValue.left;
            this.div.style.top = cssValue.top;
            this.div.style.width = cssValue.width;
            this.div.style.height = cssValue.height;
            this.div.style.boxSizing = "border-box";
            document.body.appendChild(this.div);
            if (window.boxArr == null) {
                window.boxArr = [];
            }
            boxArr.push(this.div);
        };

        function MakeBtn(values) {
            this.btn = document.createElement('button');
            this.btn.className = 'btn';
            document.body.appendChild(this.btn);
            this.btn.innerHTML = values.text;
            this.btn.style.backgroundColor = values.color;
            this.btn.style.left = values.left;
            this.btn.style.top = values.top;
            this.btn.style.width = values.width;
            this.btn.style.height = values.height;
            this.btn.style.fontSize = values.fontSize;

            var thisTarget = null;
            window.zIndex = 1;

            function boxPoint(x1, y1, x2, y2) {
                this.x1 = x1;
                this.y1 = y1;
                this.x2 = x2;
                this.y2 = y2;
            }

            this.btn.onmousedown = function(evt) {
                evt.preventDefault();
                var boxPointArr = [];
                for (var i = 0; i < boxArr.length; i++) {
                    var x1 = boxArr[i].offsetLeft;
                    var y1 = boxArr[i].offsetTop;
                    var x2 = x1 + boxArr[i].offsetWidth;
                    var y2 = y1 + boxArr[i].offsetHeight;
                    boxPointArr.push(new boxPoint(x1, y1, x2, y2));
                }

                thisTarget = this;
                thisTarget.x = thisTarget.offsetLeft;
                thisTarget.y = thisTarget.offsetTop;
                this.style.zIndex = window.zIndex;
                window.zIndex += 1;
                thisTarget.xGap = evt.clientX - thisTarget.offsetLeft;
                thisTarget.yGap = evt.clientY - thisTarget.offsetTop;

                document.onmousemove = function(moveEvent) {
                    thisTarget.style.left = moveEvent.clientX - thisTarget.xGap + "px";
                    thisTarget.style.top = moveEvent.clientY - thisTarget.yGap + "px";
                };

                document.onmouseup = function() {
                    var x1 = thisTarget.offsetLeft + thisTarget.offsetWidth / 2;
                    var y1 = thisTarget.offsetTop + thisTarget.offsetHeight / 2;
                    var idx = -1;
                    for (var i = 0; i < boxPointArr.length; i++) {
                        var p = boxPointArr[i];
                        var b1 = (x1 >= p.x1 && x1 <= p.x2) && (y1 >= p.y1 && y1 <= p.y2);
                        if (b1) {
                            idx = i;
                        }
                    }
                    if (idx != -1) {
                        thisTarget.style.left = boxPointArr[idx].x1 + "px";
                        thisTarget.style.top = boxPointArr[idx].y1 + "px";

                        // 그리드 상태 업데이트
                        const row = Math.floor(idx / 3);
                        const col = idx % 3;
                        if (!board[row][col]) {
                            board[row][col] = thisTarget.innerHTML;
                            thisTarget.onmousedown = null; // 한 번 배치된 버튼은 더 이상 움직이지 않도록
                            checkWinner();
                        }
                    } else {
                        // 그리드 밖으로 드래그한 경우 버튼이 원래 위치로 돌아가도록 함
                        thisTarget.style.left = values.left;
                        thisTarget.style.top = values.top;
                    }
                    document.onmousemove = null;
                };
            };

            this.btn.onclick = function() {
                new MakeBtn(values);
            };
        }

        function checkWinner() {
            const lines = [
                [{r: 0, c: 0}, {r: 0, c: 1}, {r: 0, c: 2}], // 첫 번째 행
                [{r: 1, c: 0}, {r: 1, c: 1}, {r: 1, c: 2}], // 두 번째 행
                [{r: 2, c: 0}, {r: 2, c: 1}, {r: 2, c: 2}], // 세 번째 행
                [{r: 0, c: 0}, {r: 1, c: 0}, {r: 2, c: 0}], // 첫 번째 열
                [{r: 0, c: 1}, {r: 1, c: 1}, {r: 2, c: 1}], // 두 번째 열
                [{r: 0, c: 2}, {r: 1, c: 2}, {r: 2, c: 2}], // 세 번째 열
                [{r: 0, c: 0}, {r: 1, c: 1}, {r: 2, c: 2}], // 왼쪽 위에서 오른쪽 아래 대각선
                [{r: 0, c: 2}, {r: 1, c: 1}, {r: 2, c: 0}]  // 오른쪽 위에서 왼쪽 아래 대각선
            ];

            for (const line of lines) {
                const [a, b, c] = line;
                if (board[a.r][a.c] && board[a.r][a.c] === board[b.r][b.c] && board[a.r][a.c] === board[c.r][c.c]) {
                    drawLine(line);
                    setTimeout(() => {
                        alert(`${board[a.r][a.c]} 플레이어 승리!`);
                        resetGame();
                    }, 100);
                    return;
                }
            }

            // 무승부 체크
            if (board.flat().every(cell => cell !== null)) {
                alert('무승부입니다!');
                resetGame();
            }
        }

        function drawLine(line) {
            const [start, , end] = line;
            const startBox = boxArr[start.r * 3 + start.c];
            const endBox = boxArr[end.r * 3 + end.c];

            const lineDiv = document.createElement('div');
            lineDiv.className = 'line';

            lineDiv.style.left = startBox.offsetLeft + "px";
            lineDiv.style.top = startBox.offsetTop + "px";
            lineDiv.style.width = endBox.offsetLeft - startBox.offsetLeft + startBox.offsetWidth + "px";
            lineDiv.style.height = endBox.offsetTop - startBox.offsetTop + startBox.offsetHeight + "px";

            if (start.r === end.r) {
                // 가로 줄
                lineDiv.style.height = "5px";
            } else if (start.c === end.c) {
                // 세로 줄
                lineDiv.style.width = "5px";
            } else {
                // 대각선 줄
                lineDiv.style.transform = "rotate(45deg)";
                lineDiv.style.width = Math.sqrt(2 * (startBox.offsetWidth ** 2)) + "px";
                lineDiv.style.height = "5px";
            }

            document.body.appendChild(lineDiv);
        }

        function resetGame() {
            board = [
                [null, null, null],
                [null, null, null],
                [null, null, null]
            ];
            document.querySelectorAll('.btn').forEach(btn => btn.remove());
            document.querySelectorAll('.line').forEach(line => line.remove());

            new MakeBtn({
                'text': 'X',
                'color': 'blue',
                'left': 'calc(50% + 250px)',
                'top': 'calc(50% + 50px)',
                'width': '100px',
                'height': '100px',
                'fontSize': '40px'
            });

            new MakeBtn({
                'text': 'O',
                'color': 'green',
                'left': 'calc(50% - 350px)',
                'top': 'calc(50% + 50px)',
                'width': '100px',
                'height': '100px',
                'fontSize': '40px'
            });
        }

        window.onload = function() {
            new MakeBtn({
                'text': 'X',
                'color': 'blue',
                'left': 'calc(50% + 250px)',
                'top': 'calc(50% + 50px)',
                'width': '100px',
                'height': '100px',
                'fontSize': '40px'
            });

            new MakeBtn({
                'text': 'O',
                'color': 'green',
                'left': 'calc(50% - 350px)',
                'top': 'calc(50% + 50px)',
                'width': '100px',
                'height': '100px',
                'fontSize': '40px'
            });

            const boxSize = 100;
            const boxMargin = 10;
            const totalGridSize = 3 * boxSize + 2 * boxMargin;
            const centerX = (window.innerWidth - totalGridSize) / 2;
            const centerY = (window.innerHeight - totalGridSize) / 2;

            for (let row = 0; row < 3; row++) {
                for (let col = 0; col < 3; col++) {
                    new MakeBox({
                        'left': `${centerX + col * (boxSize + boxMargin)}px`,
                        'top': `${centerY + row * (boxSize + boxMargin)}px`,
                        'width': `${boxSize}px`,
                        'height': `${boxSize}px`
                    });
                }
            }
        };
    </script>
</head>
<body>
    <button id="toggleButton">게임 규칙 보기</button>
    <div id="content">O 또는 X 플레이어는 1회씩 번갈아가며 두고 한줄을 먼저 완성하는 사람이 이깁니다. <br> 다른사람이 둔 곳은 다시 두지 못합니다. (막는 기능 구현 안되어있음)</div>

    <script>
        $(document).ready(function() {
            $("#toggleButton").click(function() {
                $("#content").slideToggle(); // 클릭 시 슬라이드 토글
                // 버튼 텍스트 변경
                if ($("#content").is(":visible")) {
                    $(this).text("규칙 닫기");
                } else {
                    $(this).text("게임 규칙 보기");
                }
            });
        });
    </script>
    <h1>리무쿠라 현효의 3x3 빙고게임</h1>

</body>
</html>
